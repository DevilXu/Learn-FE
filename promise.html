<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
</head>

<body>
  <script>
    function PromiseB(fn) {
      var state = 'pending',
        value = null,
        deferreds = [];

      this.then = function (onFulfilled) {
        return new PromiseB(function (resolve2) {
          handle({
            onFulfilled: onFulfilled || null,
            resolve: resolve2
          });
        });
      };

      function handle(deferred) {
        if (state === 'pending') {
          deferreds.push(deferred);
          return;
        }
        var ret = deferred.onFulfilled(value);
        deferred.resolve(ret);
      }

      function resolve(newValue) {
        if (newValue && (typeof newValue === 'object' || typeof newValue === 'function')) {
          var then = newValue.then;
          if (typeof then === 'function') {
            then.call(newValue, resolve);
            return;
          }
        }
        // state = 'fulfilled';
        value = newValue;
        setTimeout(function () {
          state = 'fulfilled';
          deferreds.forEach(function (deferred) {
            handle(deferred);
          });
        }, 0);
      }

      fn(resolve);
    }

    new PromiseB((resolve, reject) => {
      resolve(123);
    }).then((res, rej) => {
      // return new PromiseB((resolve, reject) => {
      //   setTimeout(() => {
      //     console.log(res);
      //     resolve(res + 123);
      //   }, 1000)
      // })
      console.log(res);
      return res + 123;
    }).then((res, rej) => {
      console.log(res);
    })
  </script>
</body>

</html>